<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZapMercado - Painel do Lojista</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .navbar-brand {
            font-weight: bold;
            color: #25D366 !important;
        }
        
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, #25D366, #128C7E);
            color: white;
        }
        
        .nav-pills .nav-link {
            color: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            margin-bottom: 5px;
        }
        
        .nav-pills .nav-link.active {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        .nav-pills .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .card-stats {
            border-left: 4px solid #25D366;
            transition: transform 0.2s;
        }
        
        .card-stats:hover {
            transform: translateY(-2px);
        }
        
        .produto-card {
            transition: transform 0.2s;
            height: 100%;
        }
        
        .produto-card:hover {
            transform: scale(1.02);
        }
        
        .produto-emoji {
            font-size: 3rem;
            text-align: center;
            margin-bottom: 10px;
        }
        
        .produto-imagem {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .produto-preco {
            font-size: 1.2rem;
            font-weight: bold;
            color: #25D366;
        }
        
        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            border-color: #25D366;
            background-color: #f8f9fa;
        }
        
        .upload-area.dragover {
            border-color: #25D366;
            background-color: #e8f5e8;
        }
        
        .preview-image {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .image-controls {
            margin-top: 10px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .sync-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .sync-indicator.syncing {
            color: #ffc107;
        }
        
        .sync-indicator.synced {
            color: #28a745;
        }
        
        .sync-indicator.error {
            color: #dc3545;
        }
    </style>
</head>
<body>
    <!-- Indicador de Sincroniza√ß√£o -->
    <div class="sync-indicator" id="syncIndicator" title="Status da sincroniza√ß√£o">
        <i class="fas fa-cloud fa-2x"></i>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fab fa-whatsapp"></i> ZapMercado - Lojista
            </a>
            <div class="navbar-nav ms-auto">
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button" data-bs-toggle="dropdown" id="nomeLojistaNav">
                        <img id="avatarLojista" class="user-avatar me-2" style="display: none;" alt="Avatar">
                        <i class="fas fa-user-circle me-1" id="iconeLojista"></i>
                        <span id="nomeLojista">Carregando...</span>
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#configuracoes" data-bs-toggle="pill" data-bs-target="#configuracoes">
                            <i class="fas fa-cog"></i> Configura√ß√µes</a></li>
                        <li><a class="dropdown-item" href="#" onclick="sincronizarDados()">
                            <i class="fas fa-sync-alt"></i> Sincronizar Dados</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Sair</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar p-3">
                <div class="text-center mb-4">
                    <i class="fas fa-store fa-3x mb-2"></i>
                    <h5 id="nomeLojistaSidebar">Carregando...</h5>
                    <small class="text-light" id="emailLojista">Carregando...</small>
                </div>
                
                <ul class="nav nav-pills flex-column" id="pills-tab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active w-100 text-start" id="dashboard-tab" data-bs-toggle="pill" data-bs-target="#dashboard" type="button">
                            <i class="fas fa-chart-line me-2"></i> Dashboard
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link w-100 text-start" id="pedidos-tab" data-bs-toggle="pill" data-bs-target="#pedidos" type="button">
                            <i class="fas fa-shopping-bag me-2"></i> Pedidos
                            <span class="badge bg-danger ms-2" id="badgePedidos">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link w-100 text-start" id="produtos-tab" data-bs-toggle="pill" data-bs-target="#produtos" type="button">
                            <i class="fas fa-box me-2"></i> Produtos
                            <span class="badge bg-info ms-2" id="badgeProdutos">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link w-100 text-start" id="relatorios-tab" data-bs-toggle="pill" data-bs-target="#relatorios" type="button">
                            <i class="fas fa-chart-bar me-2"></i> Relat√≥rios
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link w-100 text-start" id="configuracoes-tab" data-bs-toggle="pill" data-bs-target="#configuracoes" type="button">
                            <i class="fas fa-cog me-2"></i> Configura√ß√µes
                        </button>
                    </li>
                </ul>
            </div>

            <!-- Conte√∫do Principal -->
            <div class="col-md-9 col-lg-10 p-4">
                <div class="tab-content" id="pills-tabContent">
                    
                    <!-- Dashboard -->
                    <div class="tab-pane fade show active" id="dashboard">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2>üìä Dashboard</h2>
                            <div class="text-muted">
                                <i class="fas fa-calendar"></i> Hoje: <span id="dataAtual"></span>
                            </div>
                        </div>

                        <!-- Cards de Estat√≠sticas -->
                        <div class="row mb-4">
                            <div class="col-md-3 mb-3">
                                <div class="card card-stats h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <p class="card-category text-muted">Produtos Cadastrados</p>
                                                <h3 class="card-title text-primary" id="totalProdutos">0</h3>
                                            </div>
                                            <div class="text-primary">
                                                <i class="fas fa-box fa-2x"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card card-stats h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <p class="card-category text-muted">Pedidos Hoje</p>
                                                <h3 class="card-title text-success" id="pedidosHoje">0</h3>
                                            </div>
                                            <div class="text-success">
                                                <i class="fas fa-shopping-bag fa-2x"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card card-stats h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <p class="card-category text-muted">Faturamento</p>
                                                <h3 class="card-title text-info">R$ 0,00</h3>
                                            </div>
                                            <div class="text-info">
                                                <i class="fas fa-dollar-sign fa-2x"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card card-stats h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <p class="card-category text-muted">Avalia√ß√£o</p>
                                                <h3 class="card-title text-warning">4.8 ‚≠ê</h3>
                                            </div>
                                            <div class="text-warning">
                                                <i class="fas fa-star fa-2x"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pedidos -->
                    <div class="tab-pane fade" id="pedidos">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h3>üìã Gerenciar Pedidos</h3>
                            <button class="btn btn-primary">
                                <i class="fas fa-sync-alt"></i> Atualizar
                            </button>
                        </div>
                        <div class="text-center py-5">
                            <i class="fas fa-shopping-bag fa-3x text-muted mb-3"></i>
                            <p class="text-muted">Nenhum pedido encontrado</p>
                        </div>
                    </div>

                    <!-- Produtos -->
                    <div class="tab-pane fade" id="produtos">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h3>üì¶ Meus Produtos (<span id="contadorProdutos">0</span>)</h3>
                            <button class="btn btn-success" onclick="abrirModalProduto()">
                                <i class="fas fa-plus"></i> Adicionar Produto
                            </button>
                        </div>

                        <div class="row" id="listaProdutos">
                            <!-- Produtos ser√£o carregados aqui -->
                        </div>
                    </div>

                    <!-- Relat√≥rios -->
                    <div class="tab-pane fade" id="relatorios">
                        <h3 class="mb-4">üìä Relat√≥rios</h3>
                        <div class="text-center py-5">
                            <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                            <p class="text-muted">Relat√≥rios em desenvolvimento</p>
                        </div>
                    </div>

                    <!-- Configura√ß√µes -->
                    <div class="tab-pane fade" id="configuracoes">
                        <h3 class="mb-4">‚öôÔ∏è Configura√ß√µes da Loja</h3>
                        
                        <div class="row">
                            <div class="col-md-8">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>üè™ Informa√ß√µes da Loja</h5>
                                    </div>
                                    <div class="card-body">
                                        <form id="formConfiguracoes" onsubmit="salvarConfiguracoes(event)">
                                            <div class="mb-3">
                                                <label class="form-label">Nome da Loja</label>
                                                <input type="text" class="form-control" id="configNomeLoja" required>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">WhatsApp</label>
                                                <input type="text" class="form-control" id="configWhatsapp" required>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Taxa de Entrega (R$)</label>
                                                <input type="number" class="form-control" id="configTaxa" step="0.50" required>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Tempo de Entrega</label>
                                                <input type="text" class="form-control" id="configTempo" required>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Endere√ßo</label>
                                                <textarea class="form-control" id="configEndereco" rows="2" required></textarea>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Respons√°vel</label>
                                                <input type="text" class="form-control" id="configResponsavel" required>
                                            </div>
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-save"></i> Salvar Altera√ß√µes
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Adicionar/Editar Produto -->
    <div class="modal fade" id="produtoModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="produtoModalTitle">‚ûï Adicionar Produto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formProduto">
                        <input type="hidden" id="produtoId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Nome do Produto *</label>
                                    <input type="text" class="form-control" id="nomeProduto" required 
                                           placeholder="Ex: Arroz Branco 5kg">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Pre√ßo (R$) *</label>
                                    <input type="number" class="form-control" id="precoProduto" 
                                           step="0.01" min="0" required placeholder="Ex: 15.90">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Categoria *</label>
                                    <select class="form-select" id="categoriaProduto" required>
                                        <option value="">Selecione uma categoria...</option>
                                        <option value="gr√£os">üåæ Gr√£os e Cereais</option>
                                        <option value="latic√≠nios">ü•õ Latic√≠nios</option>
                                        <option value="carnes">ü•© Carnes e Aves</option>
                                        <option value="frutas">üçé Frutas</option>
                                        <option value="verduras">ü•¨ Verduras e Legumes</option>
                                        <option value="bebidas">ü•§ Bebidas</option>
                                        <option value="limpeza">üßΩ Produtos de Limpeza</option>
                                        <option value="higiene">üßº Higiene Pessoal</option>
                                        <option value="outros">üì¶ Outros</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Emoji (Opcional)</label>
                                    <input type="text" class="form-control" id="emojiProduto" 
                                           placeholder="üçé" maxlength="2">
                                    <small class="text-muted">Escolha um emoji que represente seu produto</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Descri√ß√£o (Opcional)</label>
                                    <textarea class="form-control" id="descricaoProduto" rows="3" 
                                              placeholder="Descri√ß√£o do produto..."></textarea>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Imagem do Produto</label>
                                    <div class="upload-area" onclick="document.getElementById('imagemProduto').click()">
                                        <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                                        <p class="text-muted mb-0">Clique aqui ou arraste uma imagem</p>
                                        <small class="text-muted">JPG, PNG - M√°ximo 2MB</small>
                                    </div>
                                    <input type="file" id="imagemProduto" accept="image/jpeg,image/png,image/jpg" 
                                           style="display: none;" onchange="processarImagem(this)">
                                    
                                    <div id="previewContainer" style="display: none;">
                                        <img id="previewImagem" class="preview-image" alt="Preview">
                                        <div class="image-controls">
                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerImagem()">
                                                <i class="fas fa-trash"></i> Remover Imagem
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="document.getElementById('imagemProduto').click()">
                                                <i class="fas fa-edit"></i> Trocar Imagem
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="salvarProduto()">
                        <i class="fas fa-save"></i> Salvar Produto
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ===== CONFIGURA√á√ÉO FIREBASE =====
        const firebaseConfig = {
            apiKey: "AIzaSyBXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
            authDomain: "zapmercado-auth.firebaseapp.com",
            projectId: "zapmercado-auth",
            storageBucket: "zapmercado-auth.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef123456789012345678"
        };

        // Inicializar Firebase se n√£o estiver inicializado
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // ===== VARI√ÅVEIS GLOBAIS =====
        let lojistaAtual = null;
        let produtosLoja = [];
        let produtoModal = null;
        let produtoEditando = null;
        let imagemAtual = null;
        let sincronizandoAtual = false;
        
        // ===== INICIALIZA√á√ÉO =====
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Iniciando sistema...');
            
            const loginValido = await verificarLogin();
            if (loginValido) {
                await inicializarSistema();
            }
        });
        
        async function inicializarSistema() {
            produtoModal = new bootstrap.Modal(document.getElementById('produtoModal'));
            await carregarConfiguracoes();
            await carregarProdutos();
            await carregarDadosFirebase();
            atualizarDataAtual();
            configurarDragAndDrop();
            configurarSincronizacaoAutomatica();
            console.log('‚úÖ Sistema inicializado com sucesso!');
        }
        
        // ===== VERIFICA√á√ÉO DE AUTENTICA√á√ÉO =====
        function verificarLogin() {
            return new Promise((resolve) => {
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        // Usu√°rio autenticado - buscar dados completos
                        try {
                            const userDoc = await db.collection('usuarios').doc(user.uid).get();
                            if (userDoc.exists) {
                                const dadosFirebase = userDoc.data();
                                
                                // Verificar se √© lojista
                                if (dadosFirebase.tipoUsuario === 'lojista') {
                                    lojistaAtual = {
                                        id: user.uid,
                                        email: user.email,
                                        nome: user.displayName || dadosFirebase.nome,
                                        foto: user.photoURL || dadosFirebase.foto,
                                        ...dadosFirebase
                                    };
                                    
                                    // Salvar no localStorage
                                    localStorage.setItem('zapMercadoLojista', JSON.stringify(lojistaAtual));
                                    atualizarInterfaceUsuario();
                                    resolve(true);
                                } else {
                                    alert('‚ùå Acesso negado! Esta √°rea √© apenas para lojistas.');
                                    window.location.href = 'auth.html';
                                    resolve(false);
                                }
                            } else {
                                throw new Error('Dados do usu√°rio n√£o encontrados');
                            }
                        } catch (error) {
                            console.error('Erro ao buscar dados:', error);
                            alert('‚ùå Erro ao carregar dados do usu√°rio');
                            window.location.href = 'auth.html';
                            resolve(false);
                        }
                    } else {
                        // Tentar localStorage como fallback
                        const dadosLocal = localStorage.getItem('zapMercadoLojista');
                        if (dadosLocal) {
                            lojistaAtual = JSON.parse(dadosLocal);
                            atualizarInterfaceUsuario();
                            resolve(true);
                        } else {
                            alert('‚ùå Voc√™ precisa fazer login primeiro!');
                            window.location.href = 'auth.html';
                            resolve(false);
                        }
                    }
                });
            });
        }
        
        function atualizarInterfaceUsuario() {
            if (!lojistaAtual) return;
            
            // Atualizar nome e email
            document.getElementById('nomeLojista').textContent = lojistaAtual.nome;
            document.getElementById('nomeLojistaSidebar').textContent = lojistaAtual.nome;
            document.getElementById('emailLojista').textContent = lojistaAtual.email;
            
            // Atualizar avatar se existir
            if (lojistaAtual.foto) {
                document.getElementById('avatarLojista').src = lojistaAtual.foto;
                document.getElementById('avatarLojista').style.display = 'block';
                document.getElementById('iconeLojista').style.display = 'none';
            }
        }
        
        // ===== LOGOUT =====
        async function logout() {
            if (confirm('üö™ Deseja realmente sair?')) {
                try {
                    // Sincronizar antes de sair
                    await sincronizarDados();
                    await auth.signOut();
                    localStorage.removeItem('zapMercadoLojista');
                    window.location.href = 'auth.html';
                } catch (error) {
                    console.error('Erro no logout:', error);
                    // Logout local mesmo se der erro
                    localStorage.removeItem('zapMercadoLojista');
                    window.location.href = 'auth.html';
                }
            }
        }

        // ===== SINCRONIZA√á√ÉO COM FIREBASE =====
        async function sincronizarDados() {
            if (!auth.currentUser || sincronizandoAtual) return;
            
            sincronizandoAtual = true;
            atualizarIndicadorSync('syncing');
            
            try {
                console.log('üîÑ Iniciando sincroniza√ß√£o...');
                
                // Sincronizar produtos
                const produtosRef = db.collection('lojistas').doc(auth.currentUser.uid).collection('produtos');
                
                // Limpar produtos antigos
                const produtosAntigos = await produtosRef.get();
                const batch = db.batch();
                
                produtosAntigos.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                // Adicionar produtos atuais
                produtosLoja.forEach(produto => {
                    const produtoRef = produtosRef.doc(produto.id.toString());
                    batch.set(produtoRef, produto);
                });
                
                await batch.commit();
                
                // Sincronizar configura√ß√µes do lojista
                await db.collection('usuarios').doc(auth.currentUser.uid).update({
                    nome: lojistaAtual.nome,
                    whatsapp: lojistaAtual.whatsapp,
                    taxa: lojistaAtual.taxa,
                    tempo: lojistaAtual.tempo,
                    endereco: lojistaAtual.endereco,
                    responsavel: lojistaAtual.responsavel,
                    ultimaAtualizacao: new Date()
                });
                
                console.log('‚úÖ Dados sincronizados com sucesso');
                atualizarIndicadorSync('synced');
                
            } catch (error) {
                console.error('‚ùå Erro na sincroniza√ß√£o:', error);
                atualizarIndicadorSync('error');
            } finally {
                sincronizandoAtual = false;
                
                // Voltar ao estado normal ap√≥s 3 segundos
                setTimeout(() => {
                    atualizarIndicadorSync('normal');
                }, 3000);
            }
                    }

        // ===== CARREGAR DADOS DO FIREBASE =====
        async function carregarDadosFirebase() {
            if (!auth.currentUser) return;
            
            try {
                console.log('üì• Carregando dados do Firebase...');
                
                // Carregar produtos
                const produtosSnapshot = await db.collection('lojistas')
                    .doc(auth.currentUser.uid)
                    .collection('produtos')
                    .get();
                
                if (!produtosSnapshot.empty) {
                    const produtosFirebase = [];
                    produtosSnapshot.forEach(doc => {
                        produtosFirebase.push(doc.data());
                    });
                    
                    // Mesclar com produtos locais (prioridade para Firebase se mais recente)
                    if (produtosFirebase.length > produtosLoja.length) {
                        produtosLoja = produtosFirebase;
                        salvarProdutos();
                        exibirProdutos();
                        atualizarContadores();
                    }
                }
                
                console.log('‚úÖ Dados carregados do Firebase');
                atualizarIndicadorSync('synced');
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados:', error);
                atualizarIndicadorSync('error');
            }
        }

        // ===== INDICADOR DE SINCRONIZA√á√ÉO =====
        function atualizarIndicadorSync(status) {
            const indicator = document.getElementById('syncIndicator');
            const icon = indicator.querySelector('i');
            
            // Remover classes anteriores
            indicator.className = 'sync-indicator';
            icon.className = 'fas fa-2x';
            
            switch(status) {
                case 'syncing':
                    indicator.classList.add('syncing');
                    icon.classList.add('fa-sync-alt', 'fa-spin');
                    indicator.title = 'Sincronizando dados...';
                    break;
                case 'synced':
                    indicator.classList.add('synced');
                    icon.classList.add('fa-cloud-upload-alt');
                    indicator.title = 'Dados sincronizados';
                    break;
                case 'error':
                    indicator.classList.add('error');
                    icon.classList.add('fa-cloud-exclamation');
                    indicator.title = 'Erro na sincroniza√ß√£o';
                    break;
                default:
                    icon.classList.add('fa-cloud');
                    indicator.title = 'Pronto para sincronizar';
            }
        }

        // ===== SINCRONIZA√á√ÉO AUTOM√ÅTICA =====
        function configurarSincronizacaoAutomatica() {
            // Sincronizar a cada 5 minutos
            setInterval(async () => {
                if (auth.currentUser && !sincronizandoAtual) {
                    await sincronizarDados();
                }
            }, 5 * 60 * 1000);
            
            // Sincronizar antes de fechar a p√°gina
            window.addEventListener('beforeunload', () => {
                if (auth.currentUser) {
                    sincronizarDados();
                }
            });
        }

        // ===== GERENCIAMENTO DE CONFIGURA√á√ïES =====
        async function carregarConfiguracoes() {
            const configuracoes = localStorage.getItem('zapMercadoConfigLojista');
            
            if (configuracoes) {
                const config = JSON.parse(configuracoes);
                lojistaAtual = { ...lojistaAtual, ...config };
                
                // Preencher formul√°rio
                document.getElementById('configNomeLoja').value = config.nome || '';
                document.getElementById('configWhatsapp').value = config.whatsapp || '';
                document.getElementById('configTaxa').value = config.taxa || '5.00';
                document.getElementById('configTempo').value = config.tempo || '30-45 minutos';
                document.getElementById('configEndereco').value = config.endereco || '';
                document.getElementById('configResponsavel').value = config.responsavel || '';
            } else {
                // Configura√ß√µes padr√£o
                document.getElementById('configTaxa').value = '5.00';
                document.getElementById('configTempo').value = '30-45 minutos';
            }
        }

        function salvarConfiguracoes(event) {
            event.preventDefault();
            
            const configuracoes = {
                nome: document.getElementById('configNomeLoja').value.trim(),
                whatsapp: document.getElementById('configWhatsapp').value.trim(),
                taxa: parseFloat(document.getElementById('configTaxa').value) || 5.00,
                tempo: document.getElementById('configTempo').value.trim(),
                endereco: document.getElementById('configEndereco').value.trim(),
                responsavel: document.getElementById('configResponsavel').value.trim()
            };
            
            // Valida√ß√µes
            if (!configuracoes.nome) {
                alert('‚ùå Nome da loja √© obrigat√≥rio!');
                return;
            }
            
            if (!configuracoes.whatsapp) {
                alert('‚ùå WhatsApp √© obrigat√≥rio!');
                return;
            }
            
            // Salvar localmente
            localStorage.setItem('zapMercadoConfigLojista', JSON.stringify(configuracoes));
            lojistaAtual = { ...lojistaAtual, ...configuracoes };
            
            // Sincronizar com Firebase
            sincronizarDados();
            
            alert('‚úÖ Configura√ß√µes salvas com sucesso!');
        }

        // ===== GERENCIAMENTO DE PRODUTOS =====
        function carregarProdutos() {
            const produtos = localStorage.getItem('zapMercadoProdutosLojista');
            if (produtos) {
                produtosLoja = JSON.parse(produtos);
                exibirProdutos();
                atualizarContadores();
            }
        }

        function salvarProdutos() {
            localStorage.setItem('zapMercadoProdutosLojista', JSON.stringify(produtosLoja));
            
            // Sincronizar automaticamente ap√≥s salvar
            if (auth.currentUser && !sincronizandoAtual) {
                setTimeout(() => sincronizarDados(), 1000);
            }
        }

        function exibirProdutos() {
            const container = document.getElementById('listaProdutos');
            
            if (produtosLoja.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Nenhum produto cadastrado</h5>
                        <p class="text-muted">Clique em "Adicionar Produto" para come√ßar</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = produtosLoja.map(produto => `
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card produto-card h-100">
                        <div class="card-body">
                            ${produto.imagemBase64 ? 
                                `<img src="${produto.imagemBase64}" class="produto-imagem" alt="${produto.nome}">` :
                                `<div class="produto-emoji">${produto.imagem}</div>`
                            }
                            <h6 class="card-title">${produto.nome}</h6>
                            <p class="produto-preco">R$ ${produto.preco.toFixed(2)}</p>
                            <p class="text-muted small mb-2">
                                <i class="fas fa-tag"></i> ${obterNomeCategoria(produto.categoria)}
                            </p>
                            ${produto.descricao ? `<p class="text-muted small">${produto.descricao}</p>` : ''}
                        </div>
                        <div class="card-footer bg-transparent">
                            <div class="btn-group w-100">
                                <button class="btn btn-outline-primary btn-sm" onclick="editarProduto(${produto.id})">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="excluirProduto(${produto.id})">
                                    <i class="fas fa-trash"></i> Excluir
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function atualizarContadores() {
            const total = produtosLoja.length;
            document.getElementById('totalProdutos').textContent = total;
            document.getElementById('contadorProdutos').textContent = total;
            document.getElementById('badgeProdutos').textContent = total;
        }

        function obterNomeCategoria(categoria) {
            const categorias = {
                'gr√£os': 'üåæ Gr√£os e Cereais',
                'latic√≠nios': 'ü•õ Latic√≠nios',
                'carnes': 'ü•© Carnes e Aves',
                'frutas': 'üçé Frutas',
                'verduras': 'ü•¨ Verduras e Legumes',
                'bebidas': 'ü•§ Bebidas',
                'limpeza': 'üßΩ Produtos de Limpeza',
                'higiene': 'üßº Higiene Pessoal',
                'outros': 'üì¶ Outros'
            };
            return categorias[categoria] || categoria;
        }

        // ===== MODAL DE PRODUTOS =====
        function abrirModalProduto() {
            produtoEditando = null;
            limparFormularioProduto();
            document.getElementById('produtoModalTitle').textContent = '‚ûï Adicionar Produto';
            produtoModal.show();
        }

        function editarProduto(id) {
            const produto = produtosLoja.find(p => p.id === id);
            if (!produto) return;

            produtoEditando = produto;
            
            // Preencher formul√°rio
            document.getElementById('produtoId').value = produto.id;
            document.getElementById('nomeProduto').value = produto.nome;
            document.getElementById('precoProduto').value = produto.preco;
            document.getElementById('categoriaProduto').value = produto.categoria;
            document.getElementById('emojiProduto').value = produto.imagem;
            document.getElementById('descricaoProduto').value = produto.descricao || '';
            
            // Mostrar imagem se existir
            if (produto.imagemBase64) {
                imagemAtual = produto.imagemBase64;
                mostrarPreview(produto.imagemBase64);
            }
            
            document.getElementById('produtoModalTitle').textContent = '‚úèÔ∏è Editar Produto';
            produtoModal.show();
        }

        function salvarProduto() {
            const nome = document.getElementById('nomeProduto').value.trim();
            const preco = parseFloat(document.getElementById('precoProduto').value);
            const categoria = document.getElementById('categoriaProduto').value;
            const emoji = document.getElementById('emojiProduto').value.trim();
            const descricao = document.getElementById('descricaoProduto').value.trim();
            
            // Valida√ß√µes
            if (!nome) {
                alert('‚ùå Nome do produto √© obrigat√≥rio!');
                return;
            }
            
            if (!preco || preco <= 0) {
                alert('‚ùå Pre√ßo deve ser maior que zero!');
                return;
            }
            
            if (!categoria) {
                alert('‚ùå Categoria √© obrigat√≥ria!');
                return;
            }
            
            if (produtoEditando) {
                // Editando produto existente
                const index = produtosLoja.findIndex(p => p.id === produtoEditando.id);
                if (index !== -1) {
                    produtosLoja[index] = {
                        ...produtoEditando,
                        nome: nome,
                        preco: preco,
                        categoria: categoria,
                        imagem: emoji || 'üì¶',
                        imagemBase64: imagemAtual,
                        descricao: descricao
                    };
                    console.log('‚úÖ Produto editado:', produtosLoja[index]);
                }
            } else {
                // Novo produto
                const novoId = produtosLoja.length > 0 ? Math.max(...produtosLoja.map(p => p.id)) + 1 : 1;
                const novoProduto = {
                    id: novoId,
                    nome: nome,
                    preco: preco,
                    categoria: categoria,
                    imagem: emoji || 'üì¶',
                    imagemBase64: imagemAtual,
                    descricao: descricao
                };
                
                produtosLoja.push(novoProduto);
                console.log('‚úÖ Novo produto adicionado:', novoProduto);
            }
            
            // Salvar e atualizar
            salvarProdutos();
            exibirProdutos();
            atualizarContadores();
            
            // Fechar modal
            produtoModal.hide();
            limparFormularioProduto();
            
            alert(produtoEditando ? '‚úÖ Produto editado com sucesso!' : '‚úÖ Produto adicionado com sucesso!');
        }
        
        function excluirProduto(id) {
            const produto = produtosLoja.find(p => p.id === id);
            if (!produto) return;
            
            if (confirm(`üóëÔ∏è Deseja excluir o produto "${produto.nome}"?`)) {
                produtosLoja = produtosLoja.filter(p => p.id !== id);
                salvarProdutos();
                exibirProdutos();
                atualizarContadores();
                alert('‚úÖ Produto exclu√≠do com sucesso!');
            }
        }
        
        function limparFormularioProduto() {
            document.getElementById('formProduto').reset();
            document.getElementById('produtoId').value = '';
            imagemAtual = null;
            document.getElementById('previewContainer').style.display = 'none';
        }

        // ===== SISTEMA DE UPLOAD DE IMAGENS =====
        function configurarDragAndDrop() {
            const uploadArea = document.querySelector('.upload-area');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                uploadArea.classList.add('dragover');
            }
            
            function unhighlight() {
                uploadArea.classList.remove('dragover');
            }
            
            uploadArea.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    processarImagem({ files: files });
                }
            }
        }
        
        function processarImagem(input) {
            const file = input.files[0];
            
            if (!file) return;
            
            // Validar tipo de arquivo
            if (!file.type.match(/^image\/(jpeg|jpg|png)$/)) {
                alert('‚ùå Por favor, selecione apenas arquivos JPG ou PNG!');
                return;
            }
            
            // Validar tamanho (2MB)
            if (file.size > 2 * 1024 * 1024) {
                alert('‚ùå A imagem deve ter no m√°ximo 2MB!');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    // Redimensionar se necess√°rio
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Definir tamanho m√°ximo
                    const maxWidth = 800;
                    const maxHeight = 600;
                    
                    let { width, height } = img;
                    
                    // Calcular novo tamanho mantendo propor√ß√£o
                    if (width > height) {
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width = (width * maxHeight) / height;
                            height = maxHeight;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Desenhar imagem redimensionada
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Converter para base64
                    imagemAtual = canvas.toDataURL('image/jpeg', 0.8);
                    
                    // Mostrar preview
                    mostrarPreview(imagemAtual);
                };
                
                img.src = e.target.result;
            };
            
            reader.readAsDataURL(file);
        }
        
        function mostrarPreview(imagemBase64) {
            document.getElementById('previewImagem').src = imagemBase64;
            document.getElementById('previewContainer').style.display = 'block';
        }
        
        function removerImagem() {
            imagemAtual = null;
            document.getElementById('previewContainer').style.display = 'none';
            document.getElementById('imagemProduto').value = '';
        }
        
        // ===== UTILIT√ÅRIOS =====
        function atualizarDataAtual() {
            const hoje = new Date();
            const dataFormatada = hoje.toLocaleDateString('pt-BR', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('dataAtual').textContent = dataFormatada;
        }
    </script>
</body>
</html>
